name: Downstream Tests

on:
  # Run after a successful release
  workflow_run:
    workflows: ["Release"]
    types: [completed]
    branches: [main]
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to test (e.g., 0.6.0)'
        required: false
        type: string

jobs:
  notify-downstream:
    name: Trigger Downstream Tests
    runs-on: ubuntu-latest
    # Only run if the release was successful
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    strategy:
      fail-fast: false
      matrix:
        repo:
          - wheblabs/cli
          - wheblabs/create-whop-app
          - wheblabs/whopship
    
    steps:
      - name: Get latest version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            VERSION=$(npm view @whoplabs/whop-client version)
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Trigger downstream test
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.DOWNSTREAM_TOKEN }}
          repository: ${{ matrix.repo }}
          event-type: upstream-release
          client-payload: |
            {
              "package": "@whoplabs/whop-client",
              "version": "${{ steps.version.outputs.version }}",
              "ref": "${{ github.sha }}"
            }

      - name: Log dispatch
        run: |
          echo "Triggered upstream-release event on ${{ matrix.repo }}"
          echo "Package: @whoplabs/whop-client"
          echo "Version: ${{ steps.version.outputs.version }}"

